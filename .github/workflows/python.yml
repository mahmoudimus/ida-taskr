# python test!
name: ida-taskr tests

on:
    push:
        branches:
            - "main"
    pull_request:
        types:
            - synchronize
            - opened
            - reopened
            - ready_for_review
        branches:
            - "main"

# cancel previous workflow jobs for PRs
concurrency:
    group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.run_id }}
    cancel-in-progress: true

jobs:
    unit-tests:
        runs-on: ubuntu-24.04
        strategy:
            matrix:
                python-version: ["3.11", "3.12", "3.13"]
        env:
            PYTHONPATH: ${{ github.workspace }}
        steps:
            - name: "Checkout ${{ github.ref }} ( ${{ github.sha }} )"
              uses: actions/checkout@v4
              with:
                  persist-credentials: false

            - name: Set up Python ${{ matrix.python-version }}
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ matrix.python-version }}
                  cache: pip

            - name: Install dependencies
              run: |
                  pip install --upgrade pip setuptools wheel uv
                  uv pip install --system -e .

            - name: Python unit tests
              run: |
                  ./run_tests.sh

    ida-integration-tests:
        runs-on: ubuntu-24.04
        strategy:
            matrix:
                python-version: ["3.10"]
                service: ["idapro-tests", "idapro-tests-9.2"]
        env:
            PYTHONPATH: ${{ github.workspace }}

        steps:
            - name: "Checkout ${{ github.ref }} ( ${{ github.sha }} )"
              uses: actions/checkout@v4
              with:
                  persist-credentials: false

            - name: Set up Python ${{ matrix.python-version }}
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ matrix.python-version }}

            - name: Login to GHCR
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Try logging in to GHCR
              run: |
                  echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            - name: Create a .env file if it doesn't exist
              run: |
                  if [ ! -f .env ]; then
                      echo "Creating .env file..."
                      touch .env
                  fi

            - name: Cache Docker image
              id: docker-cache
              uses: actions/cache@v4
              with:
                  path: /tmp/docker-cache
                  key: docker-image-${{ runner.os }}-${{ matrix.service }}-${{ hashFiles('docker-compose.yml') }}
                  restore-keys: |
                      docker-image-${{ runner.os }}-${{ matrix.service }}-${{ hashFiles('docker-compose.yml') }}

            - name: Load cached Docker image if cache exists
              if: steps.docker-cache.outputs.cache-hit == 'true'
              run: |
                  echo "Loading Docker image from cache..."
                  docker load -i /tmp/docker-cache/${{ matrix.service }}.tar || echo "No cached image to load."

            - name: Generate test binaries
              run: |
                  sudo apt-get update && sudo apt-get install -y gcc binutils
                  chmod +x scripts/generate_test_binary.sh
                  ./scripts/generate_test_binary.sh

            - name: Run tests
              run: |
                  set -e
                  docker compose run --rm --entrypoint bash ${{ matrix.service }} -c "
                      set -e
                      pip install -e .[ci]
                      python -m pytest tests/integration/ -v --tb=short --cov=src/ida_taskr --cov-report=html --cov-report=term
                  "
                  docker compose logs

            - name: Save Docker image to cache
              if: steps.docker-cache.outputs.cache-hit != 'true'
              run: |
                  echo "Caching docker image for next run..."
                  mkdir -p /tmp/docker-cache
                  docker image ls
                  TAG="${{ matrix.service }}"
                  SHA_NAME=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                    -H "Accept: application/vnd.github+json" \
                    -H "X-GitHub-Api-Version: 2022-11-28" \
                    https://api.github.com/users/mahmoudimus/packages/container/idapro-linux/versions | \
                    jq -r ".[]|select(.metadata.container.tags[]==\"${TAG}\")|.name")
                  echo "SHA_NAME: ${SHA_NAME}"
                  docker save $(docker images --format '{{.Repository}}')@${SHA_NAME} -o /tmp/docker-cache/${{ matrix.service }}.tar || echo "Failed to save image."

            - name: Upload coverage reports
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: coverage-${{ matrix.service }}
                  path: htmlcov/
                  retention-days: 7
